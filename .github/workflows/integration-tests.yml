name: Integration Tests (Advanced)

# This workflow is DISABLED by default - runs only on manual trigger
# Enable when RouterOS integration testing is ready
on:
  workflow_dispatch:
    inputs:
      routeros_version:
        description: 'RouterOS version to test'
        required: false
        default: '7.16.2'

jobs:
  manual-integration-test:
    name: Manual Integration Test - RouterOS ${{ github.event.inputs.routeros_version }}
    runs-on: ubuntu-latest

    steps:
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Check out code
        uses: actions/checkout@v3

      - name: Get dependencies
        run: go mod download

      - name: Build provider
        run: go build -v .

      - name: Start RouterOS container
        run: |
          docker run -d --name routeros \
            --cap-add=NET_ADMIN \
            --device=/dev/net/tun \
            -p 8728:8728 \
            -p 8080:80 \
            mnazarenko/docker-routeros:${{ github.event.inputs.routeros_version }}
          
          echo "Waiting for RouterOS to start..."
          for i in {1..60}; do
            if curl -s http://127.0.0.1:8080 > /dev/null 2>&1; then
              echo "RouterOS is ready!"
              exit 0
            fi
            echo -n "."
            sleep 5
          done
          echo "RouterOS failed to start"
          exit 1

      - name: Run integration tests
        run: |
          cd client
          go test -v -timeout 30m ./...
        env:
          MIKROTIK_HOST: 127.0.0.1:8728
          MIKROTIK_USER: admin
          MIKROTIK_PASSWORD: ''
          TF_ACC: 1
        continue-on-error: true

      - name: Collect logs
        if: always()
        run: |
          docker logs routeros > routeros.log 2>&1 || true
          
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: routeros-logs-${{ github.event.inputs.routeros_version }}
          path: routeros.log

      - name: Cleanup
        if: always()
        run: |
          docker stop routeros || true
          docker rm routeros || true

  feature-coverage-check:
    name: Validate Feature Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      
      - name: Validate coverage matrix
        run: |
          echo "ğŸ“Š Checking ROUTEROS7_COVERAGE.md..."
          
          if [ -f "ROUTEROS7_COVERAGE.md" ]; then
            implemented=$(grep -c "âœ…" ROUTEROS7_COVERAGE.md || echo "0")
            planned=$(grep -c "ğŸ“‹" ROUTEROS7_COVERAGE.md || echo "0")
            partial=$(grep -c "ğŸŸ¡" ROUTEROS7_COVERAGE.md || echo "0")
            
            echo "  âœ… Fully Implemented: $implemented"
            echo "  ğŸŸ¡ Partially Implemented: $partial"  
            echo "  ğŸ“‹ Planned: $planned"
            
            total=$((implemented + planned + partial))
            if [ $total -gt 0 ]; then
              coverage=$((implemented * 100 / total))
              echo "  ğŸ“ˆ Coverage: ${coverage}%"
            fi
          else
            echo "âš ï¸  ROUTEROS7_COVERAGE.md not found"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'
        continue-on-error: true
          
      - name: Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif
        continue-on-error: true

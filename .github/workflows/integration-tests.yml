name: Integration Tests

# Manual trigger only - requires RouterOS container
on:
  workflow_dispatch:
    inputs:
      routeros_version:
        description: 'RouterOS version to test'
        required: true
        default: '7.16.2'
        type: choice
        options:
          - '7.14.3'
          - '7.15.3'
          - '7.16.2'
          - '7.17.1'
      go_version:
        description: 'Go version'
        required: true
        default: '1.24'
        type: string

permissions:
  contents: read
  actions: write

jobs:
  integration-test:
    name: RouterOS ${{ inputs.routeros_version }} with Go ${{ inputs.go_version }}
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Build provider
        run: go build -v .

      - name: Start RouterOS container
        run: |
          echo "ğŸš€ Starting RouterOS ${{ inputs.routeros_version }}..."
          docker run -d --name routeros \
            --cap-add=NET_ADMIN \
            --device=/dev/net/tun \
            -p 8728:8728 \
            -p 8080:80 \
            mnazarenko/docker-routeros:${{ inputs.routeros_version }}

      - name: Wait for RouterOS
        run: |
          echo "â³ Waiting for RouterOS to start..."
          for i in {1..60}; do
            if curl -s --connect-timeout 2 http://127.0.0.1:8080 > /dev/null 2>&1; then
              echo "âœ… RouterOS is ready!"
              exit 0
            fi
            echo -n "."
            sleep 5
          done
          echo ""
          echo "âŒ RouterOS failed to start in 5 minutes"
          docker logs routeros || true
          exit 1

      - name: Run integration tests
        run: go test -v -timeout 30m ./client/...
        env:
          MIKROTIK_HOST: 127.0.0.1:8728
          MIKROTIK_USER: admin
          MIKROTIK_PASSWORD: ''
          TF_ACC: 1

      - name: Collect logs
        if: always()
        run: docker logs routeros > routeros.log 2>&1 || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: routeros-logs-${{ inputs.routeros_version }}
          path: routeros.log
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker stop routeros || true
          docker rm routeros || true

  coverage-report:
    name: Feature Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate coverage report
        run: |
          echo "ğŸ“Š RouterOS v7 Feature Coverage Report"
          echo "======================================="
          echo ""

          if [ -f "ROUTEROS7_COVERAGE.md" ]; then
            implemented=$(grep -c "âœ…" ROUTEROS7_COVERAGE.md || echo "0")
            planned=$(grep -c "ğŸ“‹" ROUTEROS7_COVERAGE.md || echo "0")
            partial=$(grep -c "ğŸŸ¡" ROUTEROS7_COVERAGE.md || echo "0")

            echo "âœ… Fully Implemented: $implemented"
            echo "ğŸŸ¡ Partially Implemented: $partial"
            echo "ğŸ“‹ Planned: $planned"
            echo ""

            total=$((implemented + planned + partial))
            if [ $total -gt 0 ]; then
              coverage=$((implemented * 100 / total))
              echo "ğŸ“ˆ Coverage: ${coverage}%"
            fi
          else
            echo "âš ï¸  ROUTEROS7_COVERAGE.md not found"
            exit 1
          fi
